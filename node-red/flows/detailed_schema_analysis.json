[
    {
        "id": "schema_analysis_tab",
        "type": "tab",
        "label": "ìƒì„¸ ìŠ¤í‚¤ë§ˆ ë¶„ì„",
        "disabled": false,
        "info": "InfluxDB ìŠ¤í‚¤ë§ˆì˜ ëª¨ë“  í•„ë“œì™€ metric ì •ë³´ë¥¼ ìƒì„¸ ë¶„ì„"
    },
    {
        "id": "inject_schema_analysis",
        "type": "inject",
        "z": "schema_analysis_tab",
        "name": "ìŠ¤í‚¤ë§ˆ ìƒì„¸ ë¶„ì„ ì‹œìž‘",
        "props": [{"p": "payload"}],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "analyze_schema",
        "payloadType": "str",
        "x": 150,
        "y": 100,
        "wires": [["get_full_schema"]]
    },
    {
        "id": "get_full_schema",
        "type": "function",
        "z": "schema_analysis_tab",
        "name": "ì „ì²´ ìŠ¤í‚¤ë§ˆ ì¡°íšŒ",
        "func": "// InfluxDB ë©”íƒ€ ë²„í‚·ì—ì„œ ëª¨ë“  ìŠ¤í‚¤ë§ˆ ì •ë³´ ì¡°íšŒ\nmsg.query = `\nfrom(bucket:\"5603a3eb-89e2-4e15-8cbb-60750c6588d3_meta\")\n  |> range(start: -90d)\n  |> filter(fn: (r) => r._measurement == \"schema\")\n  |> keep(columns: [\"_time\", \"_field\", \"_value\"])\n  |> sort(columns: [\"_time\"], desc: true)\n`;\nreturn msg;",
        "outputs": 1,
        "x": 370,
        "y": 100,
        "wires": [["debug_full_schema", "parse_all_fields"]]
    },
    {
        "id": "debug_full_schema",
        "type": "debug",
        "z": "schema_analysis_tab",
        "name": "ì „ì²´ ìŠ¤í‚¤ë§ˆ ì›ë³¸",
        "active": true,
        "tosidebar": true,
        "console": true,
        "complete": "payload",
        "targetType": "msg",
        "x": 600,
        "y": 60,
        "wires": []
    },
    {
        "id": "parse_all_fields",
        "type": "function",
        "z": "schema_analysis_tab",
        "name": "ëª¨ë“  í•„ë“œ íŒŒì‹±",
        "func": "// ìŠ¤í‚¤ë§ˆì˜ ëª¨ë“  í•„ë“œ ë¶„ì„\ntry {\n    if (!msg.payload || !Array.isArray(msg.payload)) {\n        node.warn('ìŠ¤í‚¤ë§ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');\n        return null;\n    }\n    \n    const analysis = {\n        total_records: msg.payload.length,\n        fields: {},\n        latest_time: null,\n        parsed_schemas: []\n    };\n    \n    for (const record of msg.payload) {\n        const { _time, _field, _value } = record;\n        \n        // í•„ë“œë³„ ë¶„ë¥˜\n        if (!analysis.fields[_field]) {\n            analysis.fields[_field] = {\n                count: 0,\n                latest_time: _time,\n                sample_value: _value\n            };\n        }\n        analysis.fields[_field].count++;\n        \n        // ìµœì‹  ì‹œê°„ ì—…ë°ì´íŠ¸\n        if (!analysis.latest_time || _time > analysis.latest_time) {\n            analysis.latest_time = _time;\n        }\n        \n        // JSON íŒŒì‹± ì‹œë„\n        if (_field === 'json') {\n            try {\n                const parsed = JSON.parse(_value);\n                analysis.parsed_schemas.push({\n                    time: _time,\n                    schema: parsed\n                });\n                \n                // RawDataColumns ë¶„ì„\n                if (parsed.RawDataColumns) {\n                    node.log(`ðŸ“Š RawDataColumns ë°œê²¬: ${parsed.RawDataColumns.length}ê°œ`);\n                    for (const col of parsed.RawDataColumns) {\n                        node.log(`  - ${col.DataName} (ID: ${col.DataId}, Type: ${col.DataType})`);\n                    }\n                }\n                \n                // ë‹¤ë¥¸ ìŠ¤í‚¤ë§ˆ í•„ë“œë“¤ í™•ì¸\n                const schemaKeys = Object.keys(parsed);\n                node.log(`ðŸ“‹ ìŠ¤í‚¤ë§ˆ í‚¤ë“¤: ${schemaKeys.join(', ')}`);\n                \n                // Metric ì •ë³´ ì°¾ê¸°\n                if (parsed.Metrics || parsed.metrics) {\n                    node.log('ðŸŽ¯ Metric ì •ë³´ ë°œê²¬!');\n                    analysis.metrics_found = parsed.Metrics || parsed.metrics;\n                }\n                \n                // ê¸°íƒ€ ì •ë³´ë“¤\n                for (const key of schemaKeys) {\n                    if (key.toLowerCase().includes('metric')) {\n                        node.log(`ðŸ” Metric ê´€ë ¨ í‚¤ ë°œê²¬: ${key}`);\n                        analysis[`metric_${key}`] = parsed[key];\n                    }\n                }\n                \n            } catch (parseError) {\n                node.warn(`JSON íŒŒì‹± ì‹¤íŒ¨: ${parseError.message}`);\n            }\n        }\n    }\n    \n    msg.payload = analysis;\n    node.log(`âœ… ìŠ¤í‚¤ë§ˆ ë¶„ì„ ì™„ë£Œ: ${analysis.total_records}ê°œ ë ˆì½”ë“œ, ${Object.keys(analysis.fields).length}ê°œ í•„ë“œ`);\n    return msg;\n    \n} catch (error) {\n    node.error('ìŠ¤í‚¤ë§ˆ ë¶„ì„ ì˜¤ë¥˜: ' + error.message);\n    return null;\n}",
        "outputs": 1,
        "x": 370,
        "y": 160,
        "wires": [["debug_parsed_analysis"]]
    },
    {
        "id": "debug_parsed_analysis",
        "type": "debug",
        "z": "schema_analysis_tab",
        "name": "ë¶„ì„ ê²°ê³¼",
        "active": true,
        "tosidebar": true,
        "console": true,
        "complete": "payload",
        "targetType": "msg",
        "x": 580,
        "y": 160,
        "wires": []
    },
    {
        "id": "inject_metric_search",
        "type": "inject",
        "z": "schema_analysis_tab",
        "name": "Metric ì „ìš© ê²€ìƒ‰",
        "props": [{"p": "payload"}],
        "repeat": "",
        "crontab": "",
        "once": false,
        "topic": "",
        "payload": "search_metrics",
        "payloadType": "str",
        "x": 150,
        "y": 240,
        "wires": [["search_metric_fields"]]
    },
    {
        "id": "search_metric_fields",
        "type": "function",
        "z": "schema_analysis_tab",
        "name": "Metric í•„ë“œ ê²€ìƒ‰",
        "func": "// Metric ê´€ë ¨ í•„ë“œë“¤ì„ ì§ì ‘ ê²€ìƒ‰\nmsg.query = `\nfrom(bucket:\"5603a3eb-89e2-4e15-8cbb-60750c6588d3_meta\")\n  |> range(start: -90d)\n  |> filter(fn: (r) => \n    r._field =~ /.*metric.*/ or \n    r._field =~ /.*Metric.*/ or\n    r._field =~ /.*tag.*/ or\n    r._field =~ /.*Tag.*/ or\n    r._field =~ /.*name.*/ or\n    r._field =~ /.*Name.*/\n  )\n  |> keep(columns: [\"_time\", \"_field\", \"_value\", \"_measurement\"])\n  |> sort(columns: [\"_time\"], desc: true)\n`;\nreturn msg;",
        "outputs": 1,
        "x": 370,
        "y": 240,
        "wires": [["debug_metric_search"]]
    },
    {
        "id": "debug_metric_search",
        "type": "debug",
        "z": "schema_analysis_tab",
        "name": "Metric ê²€ìƒ‰ ê²°ê³¼",
        "active": true,
        "tosidebar": true,
        "console": true,
        "complete": "payload",
        "targetType": "msg",
        "x": 590,
        "y": 240,
        "wires": []
    }
]

