[
    {
        "id": "auto_tag_tab",
        "type": "tab",
        "label": "ìë™ íƒœê·¸ ë§¤í•‘",
        "disabled": false,
        "info": "InfluxDB ë©”íƒ€ë°ì´í„°ì—ì„œ ìë™ìœ¼ë¡œ íƒœê·¸ ë§¤í•‘ì„ ìƒì„±"
    },
    {
        "id": "inject_auto_mapping",
        "type": "inject",
        "z": "auto_tag_tab",
        "name": "íƒœê·¸ ë§¤í•‘ ìë™ ìƒì„±",
        "props": [{"p": "payload"}],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 10,
        "topic": "",
        "payload": "create_mapping",
        "payloadType": "str",
        "x": 150,
        "y": 100,
        "wires": [["get_influx_schema"]]
    },
    {
        "id": "get_influx_schema",
        "type": "function",
        "z": "auto_tag_tab",
        "name": "InfluxDB ìŠ¤í‚¤ë§ˆ ì¡°íšŒ",
        "func": "// InfluxDB ë©”íƒ€ ë²„í‚·ì—ì„œ ìŠ¤í‚¤ë§ˆ ì •ë³´ ì¡°íšŒ\nmsg.query = `\nfrom(bucket:\"5603a3eb-89e2-4e15-8cbb-60750c6588d3_meta\")\n  |> range(start: -90d)\n  |> filter(fn: (r) => r._measurement == \"schema\" and r._field == \"json\")\n  |> last()\n  |> keep(columns: [\"_value\"])\n`;\nreturn msg;",
        "outputs": 1,
        "x": 380,
        "y": 100,
        "wires": [["parse_schema"]]
    },
    {
        "id": "parse_schema",
        "type": "function",
        "z": "auto_tag_tab",
        "name": "ìŠ¤í‚¤ë§ˆ íŒŒì‹± ë° SQL ìƒì„±",
        "func": "// InfluxDB ìŠ¤í‚¤ë§ˆë¥¼ íŒŒì‹±í•˜ì—¬ PostgreSQL INSERT SQL ìƒì„±\ntry {\n    if (!msg.payload || !Array.isArray(msg.payload) || msg.payload.length === 0) {\n        node.warn('ìŠ¤í‚¤ë§ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');\n        return null;\n    }\n    \n    const schemaJson = msg.payload[0]._value;\n    const schema = JSON.parse(schemaJson);\n    \n    if (!schema.RawDataColumns || !Array.isArray(schema.RawDataColumns)) {\n        node.warn('RawDataColumnsê°€ ì—†ìŠµë‹ˆë‹¤');\n        return null;\n    }\n    \n    // PostgreSQL INSERT SQL ìƒì„±\n    const insertQueries = [];\n    \n    for (const column of schema.RawDataColumns) {\n        const { DataName, DataId, DataType } = column;\n        \n        const sql = `\n            INSERT INTO influx_tag (key, tag_id, tag_name, tag_type, unit, meta)\n            VALUES ('${DataName}', '${DataId}', '${DataName}', '${DataType.toLowerCase()}', 'V', '{\"auto_created\": true}')\n            ON CONFLICT (key) DO UPDATE SET\n                tag_id = EXCLUDED.tag_id,\n                tag_name = EXCLUDED.tag_name,\n                tag_type = EXCLUDED.tag_type,\n                updated_at = CURRENT_TIMESTAMP;\n        `.trim();\n        \n        insertQueries.push(sql);\n    }\n    \n    msg.payload = {\n        schema: schema.RawDataColumns,\n        queries: insertQueries,\n        count: insertQueries.length\n    };\n    \n    node.log(`âœ… ${insertQueries.length}ê°œ íƒœê·¸ ë§¤í•‘ SQL ìƒì„± ì™„ë£Œ`);\n    return msg;\n    \n} catch (error) {\n    node.error('ìŠ¤í‚¤ë§ˆ íŒŒì‹± ì˜¤ë¥˜: ' + error.message);\n    return null;\n}",
        "outputs": 1,
        "x": 620,
        "y": 100,
        "wires": [["debug_parsed_schema", "execute_mapping_sql"]]
    },
    {
        "id": "debug_parsed_schema",
        "type": "debug",
        "z": "auto_tag_tab",
        "name": "íŒŒì‹±ëœ ìŠ¤í‚¤ë§ˆ",
        "active": true,
        "tosidebar": true,
        "console": true,
        "complete": "payload",
        "targetType": "msg",
        "x": 850,
        "y": 60,
        "wires": []
    },
    {
        "id": "execute_mapping_sql",
        "type": "function",
        "z": "auto_tag_tab",
        "name": "íƒœê·¸ ë§¤í•‘ SQL ì‹¤í–‰",
        "func": "// PostgreSQLì— íƒœê·¸ ë§¤í•‘ ë°ì´í„° ì‚½ì…\nif (!msg.payload || !msg.payload.queries || msg.payload.queries.length === 0) {\n    node.warn('ì‹¤í–‰í•  SQLì´ ì—†ìŠµë‹ˆë‹¤');\n    return null;\n}\n\n// ê° SQLì„ ê°œë³„ì ìœ¼ë¡œ ì‹¤í–‰\nconst results = [];\nfor (let i = 0; i < msg.payload.queries.length; i++) {\n    const newMsg = {\n        ...msg,\n        query: msg.payload.queries[i],\n        payload: [],\n        _msgid: msg._msgid + '_' + i\n    };\n    results.push(newMsg);\n}\n\nnode.log(`ğŸš€ ${results.length}ê°œ íƒœê·¸ ë§¤í•‘ SQL ì‹¤í–‰ ì‹œì‘`);\nreturn [results];",
        "outputs": 1,
        "x": 620,
        "y": 160,
        "wires": [["debug_mapping_result"]]
    },
    {
        "id": "debug_mapping_result",
        "type": "debug",
        "z": "auto_tag_tab",
        "name": "ë§¤í•‘ ê²°ê³¼",
        "active": true,
        "tosidebar": true,
        "console": true,
        "complete": "true",
        "targetType": "full",
        "x": 850,
        "y": 160,
        "wires": []
    }
]

